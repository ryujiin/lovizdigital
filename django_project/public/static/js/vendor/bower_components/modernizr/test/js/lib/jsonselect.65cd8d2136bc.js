/*! Copyright (c) 2011, Lloyd Hilaiel, ISC License */

!function(r){function n(r){try{return JSON&&JSON.parse?JSON.parse(r):new Function("return "+r)()}catch(n){t("ijs")}}function t(r){throw new Error(f[r])}function e(r){return Array.isArray?Array.isArray(r):"[object Array]"===u.call(r)}function s(r){if(null===r)return"null";var n=typeof r;return"object"===n&&e(r)&&(n="array"),n}function i(r,n,t,e,i){var o,c=[],a=">"===n[0]?n[1]:n[0],u=!0;return a.type&&(u=u&&a.type===s(r)),a.id&&(u=u&&a.id===t),u&&a.pf&&(":nth-last-child"===a.pf?e=i-e:e++,0===a.a?u=a.b===e:(o=(e-a.b)%a.a,u=!o&&e*a.a+a.b>=0)),">"!==n[0]&&":root"!==n[0].pc&&c.push(n),u&&(">"===n[0]?n.length>2&&(u=!1,c.push(n.slice(2))):n.length>1&&(u=!1,c.push(n.slice(1)))),[u,c]}function o(r,n,t,s,c,a){var u,f,p=","===r[0]?r.slice(1):[r],l=[],h=!1,d=0,y=0,b=0;for(d=0;d<p.length;d++)for(f=i(n,p[d],s,c,a),f[0]&&(h=!0),y=0;y<f[1].length;y++)l.push(f[1][y]);if(l.length&&"object"==typeof n)if(l.length>=1&&l.unshift(","),e(n))for(d=0;d<n.length;d++)o(l,n[d],t,void 0,d,n.length);else{b=0;for(u in n)n.hasOwnProperty(u)&&b++;d=0;for(u in n)n.hasOwnProperty(u)&&o(l,n[u],t,u,d++,b)}h&&t&&t(n)}function c(r,n){var t=[];return o(r,n,function(r){t.push(r)}),t}function a(r){return{sel:y(r),match:function(r){return c(this.sel,r)},forEach:function(r,n){return o(this.sel,r,n)}}}var u=Object.prototype.toString,f={ijs:"invalid json string",mpc:"multiple pseudo classes (:xxx) not allowed",mepf:"malformed expression in pseudo-function",nmi:"multiple ids not allowed",se:"selector expected",sra:"string required after '.'",uc:"unrecognized char",ujs:"unclosed json string",upc:"unrecognized pseudo class"},p={psc:1,psf:2,typ:3,str:4},l=/^(?:([\r\n\t\ ]+)|([*.,>])|(string|boolean|null|array|object|number)|(:(?:root|first-child|last-child|only-child))|(:(?:nth-child|nth-last-child))|(:\w+)|(\"(?:[^\\]|\\[^\"])*\")|(\")|((?:[_a-zA-Z]|[^\0-\0177]|\\[^\r\n\f0-9a-fA-F])(?:[_a-zA-Z0-9\-]|[^\u0000-\u0177]|(?:\\[^\r\n\f0-9a-fA-F]))*))/,h=/^\s*\(\s*(?:([+\-]?)([0-9]*)n\s*(?:([+\-])\s*([0-9]))?|(odd|even)|([+\-]?[0-9]+))\s*\)/,d=function(r,e){e||(e=0);var s=l.exec(r.substr(e));if(!s)return void 0;e+=s[0].length;var i;return s[1]?i=[e," "]:s[2]?i=[e,s[0]]:s[3]?i=[e,p.typ,s[0]]:s[4]?i=[e,p.psc,s[0]]:s[5]?i=[e,p.psf,s[0]]:s[6]?t("upc"):s[7]?i=[e,p.str,n(s[0])]:s[8]?t("ujs"):s[9]&&(i=[e,p.str,s[0].replace(/\\([^\r\n\f0-9a-fA-F])/g,"$1")]),i},y=function(r){for(var n,t=[],e=0;;){var s=b(r,e);if(t.push(s[1]),s=d(r,e=s[0]),s&&" "===s[1]&&(s=d(r,e=s[0])),!s)break;">"===s[1]?(t.push(">"),e=s[0]):","===s[1]&&(void 0===n?n=[",",t]:n.push(t),t=[],e=s[0])}return n&&n.push(t),n?n:t},b=function(r,n){var e=n,s={},i=d(r,n);for(i&&" "===i[1]&&(e=n=i[0],i=d(r,n)),i&&i[1]===p.typ?(s.type=i[2],i=d(r,n=i[0])):i&&"*"===i[1]&&(i=d(r,n=i[0]));;){if(void 0===i)break;if("."===i[1])i=d(r,n=i[0]),i&&i[1]===p.str||t("sra"),s.id&&t("nmi"),s.id=i[2];else if(i[1]===p.psc)(s.pc||s.pf)&&t("mpc"),":first-child"===i[2]?(s.pf=":nth-child",s.a=0,s.b=1):":last-child"===i[2]?(s.pf=":nth-last-child",s.a=0,s.b=1):s.pc=i[2];else{if(i[1]!==p.psf)break;(s.pc||s.pf)&&t("mpc"),s.pf=i[2];var o=h.exec(r.substr(i[0]));o||t("mepf"),o[5]?(s.a=2,s.b="odd"===o[5]?1:0):o[6]?(s.a=0,s.b=parseInt(o[6],10)):(s.a=parseInt((o[1]?o[1]:"+")+(o[2]?o[2]:"1"),10),s.b=o[3]?parseInt(o[3]+o[4],10):0),i[0]+=o[0].length}i=d(r,n=i[0])}return e===n&&t("se"),[n,s]};r._lex=d,r._parse=y,r.match=function(r,n){return a(r).match(n)},r.forEach=function(r,n,t){return a(r).forEach(n,t)},r.compile=a}("undefined"==typeof exports?window.JSONSelect={}:exports);